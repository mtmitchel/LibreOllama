<!DOCTYPE html>
<html>
<head>
    <title>Circle Text Contract Verification</title>
    <style>
        body {
            margin: 20px;
            font-family: 'Inter', system-ui, sans-serif;
            background: #f5f5f5;
        }
        
        .container {
            display: flex;
            gap: 40px;
            margin: 40px 0;
        }
        
        .test-case {
            position: relative;
        }
        
        /* Circle with inscribed square */
        .circle-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
        }
        
        .circle {
            width: 200px;
            height: 200px;
            border: 2px solid #333;
            border-radius: 50%;
            position: absolute;
        }
        
        /* Overlay matching the contract */
        .overlay {
            position: fixed;
            transform: translate(-50%, -50%);
            overflow: hidden;
            border: 1px solid red;
        }
        
        .pad {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 16px; /* Contract padding */
            border: 1px solid green;
        }
        
        .editor {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            border: 1px solid blue;
            outline: none;
            background: rgba(255, 255, 0, 0.1);
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.3;
            text-align: left;     /* LEFT aligned per contract */
            vertical-align: top;  /* TOP aligned per contract */
            font-size: 14px;
            overflow: hidden;
        }
        
        .editor[contenteditable] {
            cursor: text;
        }
        
        h2 {
            margin-top: 40px;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .legend-item {
            margin: 5px 0;
        }
        
        code {
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Circle Text Contract Verification</h1>
    
    <div class="legend">
        <h3>Contract Rules:</h3>
        <div class="legend-item">✅ Text box = inscribed SQUARE (side = √2 × radius)</div>
        <div class="legend-item">✅ Uniform padding = 16px on all sides</div>
        <div class="legend-item">✅ Text alignment = LEFT + TOP (not centered)</div>
        <div class="legend-item">✅ Same numbers for DOM and Konva</div>
        <div class="legend-item">
            <span style="color: red">Red border</span> = Overlay (inscribed square)<br>
            <span style="color: green">Green border</span> = Padding container<br>
            <span style="color: blue">Blue border</span> = Editor (content area)
        </div>
    </div>

    <div class="container">
        <div class="test-case">
            <h3>Contract Layout</h3>
            <div class="circle-wrapper">
                <div class="circle"></div>
                <div id="test1" style="position: absolute; left: 100px; top: 100px;">
                    <!-- Will be positioned by script -->
                </div>
            </div>
        </div>
    </div>

    <h2>Contract Math Verification</h2>
    <pre id="math-output"></pre>

    <script>
        // Contract implementation
        function calculateContract(radius, strokeWidth = 2) {
            const padPx = 16; // Contract padding
            
            // Assuming scale = 1 for simplicity
            const sx = 1;
            const sy = 1;
            const sLim = Math.min(sx, sy);
            
            // Square side in screen px
            const rClipWorld = radius - (strokeWidth / 2);
            const sidePx = Math.sqrt(2) * rClipWorld * sLim;
            
            // Content box in screen px
            const contentWpx = sidePx - 2 * padPx;
            const contentHpx = sidePx - 2 * padPx; // Square!
            
            // Map to world (at scale 1, same as px)
            const contentWWorld = contentWpx / sx;
            const contentHWorld = contentHpx / sy;
            
            return {
                radius,
                sidePx,
                contentWpx,
                contentHpx,
                padPx,
                contentWWorld,
                contentHWorld,
                sx,
                sy,
                sLim
            };
        }
        
        // Create test overlay
        function createOverlay(containerId, measurement) {
            const container = document.getElementById(containerId);
            
            // Create overlay structure per contract
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.style.width = `${measurement.sidePx}px`;
            overlay.style.height = `${measurement.sidePx}px`;
            overlay.style.left = '0';
            overlay.style.top = '0';
            overlay.style.position = 'absolute';
            overlay.style.transform = 'translate(-50%, -50%)';
            
            const pad = document.createElement('div');
            pad.className = 'pad';
            
            const editor = document.createElement('div');
            editor.className = 'editor';
            editor.contentEditable = 'true';
            editor.textContent = 'hey hey hey hey\nhey hey hey hey\nhey hey hey hey\nhey hey hey hey\nhey hey hey hey';
            
            pad.appendChild(editor);
            overlay.appendChild(pad);
            container.appendChild(overlay);
            
            return { overlay, pad, editor };
        }
        
        // Test with radius 100px
        const radius = 100;
        const measurement = calculateContract(radius);
        
        // Display math
        document.getElementById('math-output').textContent = `
Contract Calculation (radius = ${radius}px):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rClipWorld = ${radius} - 1 = ${measurement.radius - 1}
sidePx = √2 × ${measurement.radius - 1} = ${measurement.sidePx.toFixed(2)}px

contentWpx = ${measurement.sidePx.toFixed(2)} - 32 = ${measurement.contentWpx.toFixed(2)}px
contentHpx = ${measurement.sidePx.toFixed(2)} - 32 = ${measurement.contentHpx.toFixed(2)}px

✅ Content is SQUARE: ${measurement.contentWpx.toFixed(2)} × ${measurement.contentHpx.toFixed(2)}
✅ Padding is UNIFORM: ${measurement.padPx}px on all sides
✅ Text is LEFT + TOP aligned (see visual)
        `;
        
        // Create visual test
        const { overlay, pad, editor } = createOverlay('test1', measurement);
        
        // Log for verification
        console.log('Contract Measurement:', measurement);
        console.log('DOM Elements:', { overlay, pad, editor });
        
        // Verify square
        setTimeout(() => {
            const editorRect = editor.getBoundingClientRect();
            console.log('Editor actual size:', {
                width: editorRect.width,
                height: editorRect.height,
                isSquare: Math.abs(editorRect.width - editorRect.height) < 1
            });
        }, 100);
    </script>
</body>
</html>