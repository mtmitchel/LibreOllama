<!DOCTYPE html>
<html>
<head>
    <title>Canvas Tool Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: monospace;
        }
        #log {
            background: #f5f5f5;
            padding: 10px;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }
        .debug { color: #666; }
        .warn { color: #ff9800; background: #fff3e0; }
        .error { color: #f44336; background: #ffebee; }
        .success { color: #4caf50; background: #e8f5e9; }
    </style>
</head>
<body>
    <h1>Canvas Tool Test</h1>
    <div id="log">
        <div class="log-entry">Waiting for console logs...</div>
    </div>
    
    <iframe src="http://localhost:1426/canvas" width="100%" height="600" style="border: 1px solid #ccc;"></iframe>
    
    <script>
        // Capture console logs from the iframe
        const logDiv = document.getElementById('log');
        let logCount = 0;
        
        function addLog(type, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${++logCount}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Override console methods to capture logs
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'console') {
                addLog(event.data.level, event.data.message);
            }
        });
        
        // Inject script into iframe when it loads
        const iframe = document.querySelector('iframe');
        iframe.onload = () => {
            try {
                // Access iframe's window
                const iframeWindow = iframe.contentWindow;
                
                // Inject console interceptor
                iframeWindow.eval(`
                    const originalLog = console.log;
                    const originalWarn = console.warn;
                    const originalError = console.error;
                    
                    console.log = function(...args) {
                        originalLog.apply(console, args);
                        parent.postMessage({
                            type: 'console',
                            level: 'debug',
                            message: args.join(' ')
                        }, '*');
                    };
                    
                    console.warn = function(...args) {
                        originalWarn.apply(console, args);
                        parent.postMessage({
                            type: 'console',
                            level: 'warn',
                            message: args.join(' ')
                        }, '*');
                    };
                    
                    console.error = function(...args) {
                        originalError.apply(console, args);
                        parent.postMessage({
                            type: 'console',
                            level: 'error',
                            message: args.join(' ')
                        }, '*');
                    };
                    
                    console.log('[Test] Console interceptor installed');
                    
                    // Log tool system status every 2 seconds
                    setInterval(() => {
                        const toolSystem = window.__getToolSystem?.();
                        if (toolSystem && toolSystem.registry) {
                            const activeTool = toolSystem.registry.getActiveTool();
                            console.log('[ToolSystem Status] Active tool:', activeTool?.id || 'none');
                        }
                    }, 2000);
                `);
                
                addLog('success', 'Test page loaded and console interceptor installed');
            } catch (e) {
                addLog('error', 'Failed to inject console interceptor: ' + e.message);
            }
        };
    </script>
</body>
</html>