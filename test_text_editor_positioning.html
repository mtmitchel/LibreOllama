<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Editor Positioning Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #test-container {
            border: 2px solid #ccc;
            width: 800px;
            height: 600px;
            position: relative;
            background: #f9f9f9;
        }
        #status {
            margin-bottom: 20px;
            padding: 10px;
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 4px;
        }
        .test-results {
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <h1>Text Editor Positioning Test</h1>
    <div id="status">Loading canvas system...</div>

    <div id="test-container">
        <!-- Canvas will be inserted here -->
    </div>

    <div class="test-results" id="results">
        <h3>Test Results:</h3>
        <div id="test-output">Initializing tests...</div>
    </div>

    <script>
        // Simulate the canvas environment for testing
        console.log('Starting text editor positioning test...');

        let testResults = [];

        function addTestResult(name, success, details) {
            testResults.push({ name, success, details });
            updateResults();
        }

        function updateResults() {
            const output = document.getElementById('test-output');
            output.innerHTML = testResults.map(result =>
                `<div class="${result.success ? 'success' : 'error'}">
                    <strong>${result.name}:</strong> ${result.success ? 'PASS' : 'FAIL'}
                    ${result.details ? `<br><small>${result.details}</small>` : ''}
                </div>`
            ).join('');
        }

        // Simulate Konva stage setup
        function simulateStageSetup() {
            // Mock stage object to test coordinate calculations
            const mockStage = {
                position: () => ({ x: 0, y: 0 }), // Should be (0,0) after fix
                scale: () => ({ x: 1, y: 1 }),
                scaleX: () => 1,
                getPointerPosition: () => ({ x: 200, y: 300 }),
                container: () => ({
                    getBoundingClientRect: () => ({
                        left: 100,
                        top: 50,
                        width: 800,
                        height: 600
                    })
                }),
                getAbsoluteTransform: () => ({
                    point: (p) => p // Identity transform when stage is at (0,0)
                })
            };

            return mockStage;
        }

        function testStagePositioning() {
            const stage = simulateStageSetup();
            const pos = stage.position();

            const success = pos.x === 0 && pos.y === 0;
            addTestResult(
                'Stage Position at Origin',
                success,
                `Stage position: (${pos.x}, ${pos.y}) - ${success ? 'Correct' : 'Should be (0, 0)'}`
            );
        }

        function testCoordinateTransformation() {
            const stage = simulateStageSetup();
            const clickPos = stage.getPointerPosition();
            const containerRect = stage.container().getBoundingClientRect();

            // Simulate text editor positioning calculation
            const expectedLeft = containerRect.left + clickPos.x;
            const expectedTop = containerRect.top + clickPos.y;

            // These should be reasonable screen coordinates, not thousands of pixels off
            const isReasonable = expectedLeft < 1000 && expectedTop < 700 && expectedLeft > 0 && expectedTop > 0;

            addTestResult(
                'Coordinate Transformation',
                isReasonable,
                `Click at (${clickPos.x}, ${clickPos.y}) → Screen position (${expectedLeft}, ${expectedTop})`
            );
        }

        function testViewportPanHandling() {
            // Test that viewport pan doesn't affect click coordinate calculations
            const mockViewport = { x: -2048, y: -1024, scale: 1 }; // Simulated problematic viewport

            // With the fix, stage should remain at (0,0) regardless of viewport pan
            const stagePos = { x: 0, y: 0 }; // Fixed stage position
            const clickWorld = { x: 200, y: 300 };

            // Text editor should position at click location in screen coordinates
            const containerRect = { left: 100, top: 50 };
            const screenPos = {
                left: containerRect.left + clickWorld.x,
                top: containerRect.top + clickWorld.y
            };

            const isCorrect = screenPos.left === 300 && screenPos.top === 350;

            addTestResult(
                'Viewport Pan Independence',
                isCorrect,
                `Viewport pan (${mockViewport.x}, ${mockViewport.y}) doesn't affect text editor positioning: (${screenPos.left}, ${screenPos.top})`
            );
        }

        function runAllTests() {
            document.getElementById('status').textContent = 'Running positioning tests...';

            testStagePositioning();
            testCoordinateTransformation();
            testViewportPanHandling();

            const allPassed = testResults.every(r => r.success);
            document.getElementById('status').innerHTML = allPassed
                ? '<span style="color: green;">✓ All tests passed! Text editor positioning should work correctly.</span>'
                : '<span style="color: red;">✗ Some tests failed. Text editor positioning may still have issues.</span>';
        }

        // Run tests when page loads
        setTimeout(runAllTests, 100);
    </script>
</body>
</html>